{{~#*inline "to_percentage"~}}
  {{round (multiply (divide (subtract score lower) (subtract upper lower)) 100) "up"}}
{{~/inline~}}

{{~#*inline "get_average"~}}
  {{~#compare income_band "0"~}}
    {{#if (getProperty dataAverages aggregation)}}
      {{round (getProperty dataAverages aggregation) "up"}}
    {{else}}
      0
    {{/if}}
  {{else}}
    {{#compare (length dataAverages.grouped_by_income_band.buckets) ">" 0}}
      {{#if (getProperty (firstItem (filter dataAverages.grouped_by_income_band.buckets "key" "===" income_band)) aggregation) ~}}
        {{round (getProperty (firstItem (filter dataAverages.grouped_by_income_band.buckets "key" "===" income_band)) aggregation) "up"}}
      {{else}}
        0
      {{/if ~}}
    {{else}}
      0
    {{/compare ~}}
  {{~/compare~}}
{{~/inline~}}

{{~#*inline "section"~}}
  {{#json key=key}}
    {{{json key="respondent" value=(lookup rootResponse percentageKey)}}},
    {{#each additionalResponses}}
      {{{json key=(concat "shared_" (add @index 1) "_percentage") value=(default (lookup _source percentageKey) 0)}}},
    {{/each}}
    {{{json key="income_band" value=(if (compare @root.data.additionalResponses.hits.total ">" 3) 0 else=rootResponse.income_band)}}},
    {{#json key="average" type="number"}}
      {{>get_average aggregation=(concat aggregation ".avg") income_band=(if (compare @root.data.additionalResponses.hits.total ">" 3) "0" else=rootResponse.income_band)}}
    {{/json}},
    {{{json key="title" value=title}}},
    {{{json key="icon" value=icon}}}
  {{/json}}
{{~/inline~}}

{{~#withExtend this
  dataAverages=@root.data.averages.aggregations
  query=@root.request.params.query
  rootResponse=@root.data.rootResponse
  additionalResponses=@root.data.additionalResponses.hits.hits
  currentSite=@root.data.currentSite ~}}
  {{#compare @root.data.currentSite.type "organisation"}}
    {{#if query.rid ~}}
      {
        "overall": {
          "respondent": {{rootResponse.percentage_total}},
          {{#each additionalResponses}}
            {{{json key=(concat "shared_" (add @index 1) "_name") value=_source.name}}},
            {{{json key=(concat "shared_" (add @index 1) "_date") value=_source.date_last_modified}}},
            {{{json key=(concat "shared_" (add @index 1) "_percentage") value=(default _source.percentage_total 0)}}},
          {{/each}}
          {{#compare @root.data.additionalResponses.hits.total ">" 3 ~}}
          "average": {{>get_average aggregation="total_stats.avg" income_band="0"}}
          {{else}}
          "average": {{>get_average aggregation="total_stats.avg" income_band=rootResponse.income_band}}
          {{/compare ~}}
        },
        {{{json key="test" value="Working"}}},
        {{#json key="sections"}}
          {{#each currentSite.metrics}}
            {{>section ../this key=key percentageKey=percentageKey aggregation=aggregation title=title icon=icon}},
          {{/each}}
        {{/json}},
        "totalRespondents": {{#if (getProperty (firstItem (filter dataAverages.grouped_by_income_band.buckets "key" "===" rootResponse.income_band)) "doc_count")}}{{getProperty (firstItem (filter dataAverages.grouped_by_income_band.buckets "key" "===" rootResponse.income_band)) "doc_count"}}{{else}}0{{/if}},
        {{#each @root.context.metaData.areas ~}}
        {{#compare slug rootResponse.area ~}}
        "whereEventual": "{{{long}}}",
        {{/compare ~}}
        {{/each ~}}
        "where": "{{#compare rootResponse.area "scotland"}}Scotland{{else}}the UK{{/compare}}"
      }
    {{else}}
      {{!-- this is legacy from before we used rid= to identify reponses in on the results page, please ignore and don't touch --}}
      {
        "overall": {
          "respondent": {{>to_percentage
              arr=(concat query.s1 "," query.s2 "," query.s3 "," query.s4)
              score=(sumArray (split (concat query.s1 "," query.s2 "," query.s3 "," query.s4) ","))
              lower=-18 upper=136~}},
          "average": {{>get_average aggregation="total_stats.avg" income_band=query.income_band}}
        },
        "sections": {
          "leadership": {
            "respondent": {{>to_percentage score=query.s1 lower=-4 upper=20}},
            "average": {{>get_average aggregation="leadership_culture_and_skills_stats.avg" income_band=query.income_band}},
            "title": "Leadership, culture and skills",
            "icon": "leadership"
          },
          "tools": {
            "respondent": {{>to_percentage score=query.s2 lower=-2 upper=35}},
            "average": {{>get_average aggregation="tools_and_equipment_stats.avg" income_band=query.income_band}},
            "title": "Tools and equipment",
            "icon": "tools"
          },
          "data": {
            "respondent": {{>to_percentage score=query.s3 lower=-10 upper=66}},
            "average": {{>get_average aggregation="content_marketing_and_data_stats.avg" income_band=query.income_band}},
            "title": "Content, marketing and data",
            "icon": "leadership"
          },
          "cyber": {
            "respondent": {{>to_percentage score=query.s4 lower=-2 upper=15}},
            "average": {{>get_average aggregation="cyber_resilience_stats.avg" income_band=query.income_band}},
            "title": "Cyber resilience",
            "icon": "resilience"
          }
        },
        "totalRespondents": {{default (getProperty (firstItem (filter dataAverages.grouped_by_income_band.buckets "key" "===" query.income_band)) "doc_count") ""}},
        {{#each @root.context.metaData.areas ~}}
          {{#compare slug query.area ~}}
            "whereEventual": "{{{long}}}",
          {{/compare ~}}
        {{/each ~}}
        "where": "{{#compare query.area "scotland"}}Scotland{{else}}the UK{{/compare}}"
      }
    {{/if ~}}
  {{else}}
    {}
  {{/compare}}
{{/withExtend ~}}